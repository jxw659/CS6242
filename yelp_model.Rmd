---
title: "Yelp Model"
output: html_notebook

---
### **Set-up**

Load packages

```{r message=FALSE, warning=FALSE}
options(scipen=999)
options(dplyr.summarise.inform = FALSE)

library(tidyverse)
library(ggplot2)
library(lubridate)
library(corrplot)
library(readr)
library(caret) 
library(randomForest)
"%ni%" <- Negate("%in%")
percentf <- function(x, digits = 2, format = "f", ...) {
  paste0(formatC(100 * x, format = format, digits = digits, ...), "%")
}
```

Load data

> Note: if the below chunk doesn't execute, you'll need to generate a new urlfile by viewing the raw dataset on github, and copying the url 

```{r load data, warning=FALSE, include=FALSE}
# --- frisco & enterprise
urlfile="https://raw.githubusercontent.com/jxw659/CS6242/Samuel_work/Cleaned%20Frisco%20and%20Enterprise.csv?token=GHSAT0AAAAAAB3H4L3Y75LLI4OYGAPRFXB6Y34H7VA"
df1 <- readr::read_csv(url(urlfile))
df1 <- df1 %>% select(-X1)

# --- conroe & meridan
urlfile="https://raw.githubusercontent.com/jxw659/CS6242/Samuel_work/Conroe_and_Meridan_Cleaned_Data.csv?token=GHSAT0AAAAAAB3H4L3Z44ENDMZCSAERVFSEY34IAMA"
df2 <- readr::read_csv(url(urlfile))
df2 <- df2 %>% select(-X1)
df <- rbind(df1,df2)
```

### **Data Cleaning**

```{r}
head(df)
```

Check NAs

```{r check na, warning=FALSE}
df %>%
  select(-id) %>%
  summarise_all(funs(sum(is.na(.))))
```

28% of records are missing price...

#### Add Breakfast/Lunch/Dinner/Late 

```{r}
df <-
df %>%
  mutate(open_hour=as.integer(substr(`Opening Time`,1,2)),
         close_hour=as.integer(substr(`Closing Time`,1,2))) %>%
  mutate(Open_Breakfast = if_else(open_hour <= 10,1,0),
         Open_Lunch = if_else(open_hour <= 12 & close_hour >= 12,1,0),
         Open_Dinner = if_else(open_hour <= 18 & (close_hour >= 18 | close_hour <=2),1,0),
         Open_Late = if_else(close_hour >= 22 | close_hour <= 2,1,0))
```

If Opening/Closing Time is NULL, can we determine breakfast/lunch/dinner/late status using restaurant category?

```{r}
df <-
df %>%
  mutate(Open_Breakfast = if_else(is.na(Open_Breakfast) & (grepl('breakfast|diner|brunch',`Restaurant Category 1`) |
                                                             grepl('breakfast|diner|brunch',`Restaurant Category 2`) |
                                                             grepl('breakfast|diner|brunch',`Restaurant Category 3`)),1,Open_Breakfast),
         Open_Lunch = if_else(is.na(Open_Lunch) & (grepl('lunch|brunch',`Restaurant Category 1`) |
                                                             grepl('lunch|brunch',`Restaurant Category 2`) |
                                                             grepl('lunch|brunch',`Restaurant Category 3`)),1,Open_Lunch),
         Open_Dinner = if_else(is.na(Open_Dinner) & (grepl('dinner',`Restaurant Category 1`) |
                                                             grepl('dinner',`Restaurant Category 2`) |
                                                             grepl('dinner',`Restaurant Category 3`)),1,Open_Dinner)) %>%
  mutate(Open_Breakfast = if_else(is.na(Open_Breakfast),0,Open_Breakfast),
         Open_Lunch = if_else(is.na(Open_Lunch),0,Open_Lunch),
         Open_Dinner = if_else(is.na(Open_Dinner),0,Open_Dinner),
         Open_Late = if_else(is.na(Open_Late),0,Open_Late))
```


#### Chunk restaurant categories

```{r}
rbind(df %>% select(restaurant_category=`Restaurant Category 1`),
      df %>% select(restaurant_category=`Restaurant Category 2`),
      df %>% select(restaurant_category=`Restaurant Category 3`)) %>%
  distinct() 
```

```{r}
df %>% distinct(`Restaurant Category 1`,`Restaurant Category 2`,`Restaurant Category 3`)
```

```{r}
df <-
df %>%
  mutate(restaurant_category=case_when(`Restaurant Category 1` %in% c("thai","japanese","chinese","asianfusion","sushi","indpak","noodles","vietnamese","pakistani",
                                                                      "laotian","ramen","korean","mongolian","dimsum","taiwanese","hotpot","filipino","conveyorsushi",
                                                                      "teppanyaki","cantonese","izakaya","japacurry","panasian","karaoke") |
                                       `Restaurant Category 2` %in% c("thai","japanese","chinese","asianfusion","sushi","indpak","noodles","vietnamese","pakistani",
                                                                    "laotian","ramen","korean","mongolian","dimsum","taiwanese","hotpot","filipino","conveyorsushi",
                                                                    "teppanyaki","cantonese","izakaya","japacurry","panasian","karaoke") |
                                       `Restaurant Category 3` %in% c("thai","japanese","chinese","asianfusion","sushi","indpak","noodles","vietnamese","pakistani",
                                                                    "laotian","ramen","korean","mongolian","dimsum","taiwanese","hotpot","filipino","conveyorsushi",
                                                                    "teppanyaki","cantonese","izakaya","japacurry","panasian","karaoke") ~"asian",
                                       
                                       `Restaurant Category 1` %in% c("italian","greek","portuguese","french","scandinavian","spanish","tapasmallplates","tapas",
                                                                      "british","fishnchips","german","irish","pastashops","modern_european","mediterranean") |
                                       `Restaurant Category 2` %in% c("italian","greek","portuguese","french","scandinavian","spanish","tapasmallplates","tapas",
                                                                      "british","fishnchips","german","irish","pastashops","modern_european","mediterranean") |
                                       `Restaurant Category 3` %in% c("italian","greek","portuguese","french","scandinavian","spanish","tapasmallplates","tapas",
                                                                      "british","fishnchips","german","irish","pastashops","modern_european","mediterranean") ~"european",
                                       
                                       `Restaurant Category 1` %in% c("mideastern","halal","persian","turkish","falafel","syrian","kebab","lebanese","armenian")|
                                       `Restaurant Category 2` %in% c("mideastern","halal","persian","turkish","falafel","syrian","kebab","lebanese","armenian")|
                                       `Restaurant Category 3` %in% c("mideastern","halal","persian","turkish","falafel","syrian","kebab","lebanese","armenian")~"mideastern",
                                       
                                       `Restaurant Category 1` %in% c("latin","tex-mex","mexican","salvadoran","tacos","brazilian","newmexican")|
                                       `Restaurant Category 2` %in% c("latin","tex-mex","mexican","salvadoran","tacos","brazilian","newmexican")|
                                       `Restaurant Category 3` %in% c("latin","tex-mex","mexican","salvadoran","tacos","brazilian","newmexican")~"latin",
                                       
                                       `Restaurant Category 1` %in% c("bbq","soulfood","salad","tradamerican","hotdogs","sandwiches","pizza","burgers","chicken_wings",
                                                                      "chickenshop","soup","delis","newamerican","hotdog","southern","cajun","cheesesteaks","smokehouse",
                                                                      "steak") |
                                       `Restaurant Category 2` %in% c("bbq","soulfood","salad","tradamerican","hotdogs","sandwiches","pizza","burgers","chicken_wings",
                                                                      "chickenshop","soup","delis","newamerican","hotdog","southern","cajun","cheesesteaks","smokehouse",
                                                                      "steak") |
                                       `Restaurant Category 3` %in% c("bbq","soulfood","salad","tradamerican","hotdogs","sandwiches","pizza","burgers","chicken_wings",
                                                                      "chickenshop","soup","delis","newamerican","hotdog","southern","cajun","cheesesteaks","smokehouse",
                                                                      "steak")~"american",
                                       
                                       `Restaurant Category 1` %in% c("shavedice","desserts","icecream","cakeshop","bakeries","bubbletea","creperies","donuts","waffles",
                                                                      "cupcakes","gelato")|
                                       `Restaurant Category 2` %in% c("shavedice","desserts","icecream","cakeshop","bakeries","bubbletea","creperies","donuts","waffles",
                                                                      "cupcakes","gelato")|
                                       `Restaurant Category 3` %in% c("shavedice","desserts","icecream","cakeshop","bakeries","bubbletea","creperies","donuts","waffles",
                                                                      "cupcakes","gelato")~"desserts",
                                       
                                       `Restaurant Category 1` %in% c("breakfast_brunch","coffee","cafes","acaibowls","juicebars","pancakes","diners") |
                                       `Restaurant Category 2` %in% c("breakfast_brunch","coffee","cafes","acaibowls","juicebars","pancakes","diners") |
                                       `Restaurant Category 3` %in% c("breakfast_brunch","coffee","cafes","acaibowls","juicebars","pancakes","diners") ~"breakfast",
                                       
                                       `Restaurant Category 1` %in% c("hawaiian","poke") |
                                       `Restaurant Category 2` %in% c("hawaiian","poke") |
                                       `Restaurant Category 3` %in% c("hawaiian","poke") ~"hawaiian",
                                       
                                       TRUE~"other"))

```

How many records are still missing restaurant_category?
```{r}
df %>%
  summarise(total_records=sum(n()),
            missing_restaurant_cat=sum(restaurant_category=='other')) %>%
  mutate(missing_percent=percentf(missing_restaurant_cat/total_records))
```

Remove odd records based on location

```{r}
df %>% group_by(State) %>% tally()
```

```{r}
df <- df %>% filter(State %ni% c('CA','ND'))
```

Translate 'is_claimed' to boolean

```{r}
df <- df %>% mutate(is_claimed=if_else(is_claimed=='TRUE',1,0))
```


### **Feature Engineering**

```{r}
df_select <-
df %>%
  mutate(price=if_else(is.na(`Price Level`),"NA",`Price Level`)) %>%
  select(is_claimed,review_count,rating,restaurant_category,pickup=`Pickup Available`,delivery=`Delivery Available`,reservation=`Reservation Available`,
         price,State,messaging=`Has Messaging`,Open_Breakfast,Open_Lunch,Open_Dinner,Open_Late)
```


One-hot encode categorical features

```{r}
dummy <- dummyVars("~.",data=df_select)
df_onehot <- data.frame(predict(dummy,newdata=df_select))
head(df_onehot)
```

### **Random Forest**

OOB

```{r}
# --- bucket the rating (ordinal) to "high"/"low" (categorical)
df_model <-
  df_onehot %>%
  mutate(rating=case_when(rating <= 3.5~'low',
                          TRUE~'high'))

set.seed(149)
# --- split training 80:20
inTraining <- createDataPartition(df_model$rating, p = .8, list = FALSE)
training <- df_model[ inTraining,]
testing  <- df_model[-inTraining,]

set.seed(149)

# --- use out-of-bag method for error estimation. 
control <- trainControl(method = "oob", number=5, sampling="up", search="random", verboseIter=TRUE, savePredictions=TRUE)

# search: hyperparameter search (grid, random); random search works better for lower dimensional data; for rf, you can tune mtry (number of variables to randomly sample as candidates at each split) and ntree (number of branches will grow after each time split)
# number: number of resampling iterations (numeric)
# sampling: sampling method (up,down)

model <- train(rating ~., data=training,
               method="rf",
               trControl = control)

print(model)
```

Variable importance
```{r}
varImp(model)
```


```{r}
training %>%
  group_by(rating) %>%
  summarise(reviews_mean=mean(review_count))
```

> **Observations**: review_count is highly predictive, which makes sense given review_count is a factor of time, and if a business has been around for along time, it's likely successful. State is also predictive, but since we want our model to predict across states/cities, can State be removed while maintaining an acceptable accuracy?


```{r}
# --- bucket the rating (ordinal) to "high"/"low" (categorical)
df_model <-
  df_onehot %>%
  mutate(rating=case_when(rating <= 3.5~'low',
                          TRUE~'high'))

set.seed(149)
# --- split training 80:20
inTraining <- createDataPartition(df_model$rating, p = .8, list = FALSE) 
training <- df_model[ inTraining,] %>% select(-StateID, -StateNV, -StateTX)
testing  <- df_model[-inTraining,]

set.seed(149)

# --- use out-of-bag method for error estimation. 
control <- trainControl(method = "oob", number=5, sampling="up", search="random", verboseIter=TRUE, savePredictions=TRUE)

# search: hyperparameter search (grid, random); random search works better for lower dimensional data; for rf, you can tune mtry (number of variables to randomly sample as candidates at each split) and ntree (number of branches will grow after each time split)
# number: number of resampling iterations (numeric)
# sampling: sampling method (up,down)

model <- train(rating ~., data=training,
               method="rf",
               trControl = control)

print(model)
```

Variable importance 

```{r}
varImp(model)
```

Predict on test set and create confusion matrix
```{r}
predict(model, newdata = testing) %>%
  confusionMatrix(., as.factor(testing$rating))
```

State == ID

```{r}
predictions <- data.frame(predicted_rating=predict(model, newdata = testing %>% filter(StateID==1)))

# --- accuracy 
predictions %>%
  cbind(.,testing %>% filter(StateID==1)) %>%
  mutate(accurate=if_else(rating==predicted_rating,1,0)) %>%
  summarise(accuracy=sum(accurate)/sum(n()))

# --- confusion matrix
predictions %>%
  cbind(.,testing %>% filter(StateID==1)) %>%
  group_by(rating,predicted_rating) %>%
  summarise(counts=sum(n())) %>%
  mutate(perc=percentf(counts/sum(counts))) %>%
  select(-counts) %>%
  pivot_wider(names_from=predicted_rating,values_from=perc)
```

State == TX

```{r}
predictions <- data.frame(predicted_rating=predict(model, newdata = testing %>% filter(StateTX==1)))

# --- accuracy 
predictions %>%
  cbind(.,testing %>% filter(StateTX==1)) %>%
  mutate(accurate=if_else(rating==predicted_rating,1,0)) %>%
  summarise(accuracy=sum(accurate)/sum(n()))

# --- confusion matrix
predictions %>%
  cbind(.,testing %>% filter(StateTX==1)) %>%
  group_by(rating,predicted_rating) %>%
  summarise(counts=sum(n())) %>%
  mutate(perc=percentf(counts/sum(counts))) %>%
  select(-counts) %>%
  pivot_wider(names_from=predicted_rating,values_from=perc)
```

State == NV

```{r}
predictions <- data.frame(predicted_rating=predict(model, newdata = testing %>% filter(StateNV==1)))

# --- accuracy 
predictions %>%
  cbind(.,testing %>% filter(StateNV==1)) %>%
  mutate(accurate=if_else(rating==predicted_rating,1,0)) %>%
  summarise(accuracy=sum(accurate)/sum(n()))

# --- confusion matrix
predictions %>%
  cbind(.,testing %>% filter(StateNV==1)) %>%
  group_by(rating,predicted_rating) %>%
  summarise(counts=sum(n())) %>%
  mutate(perc=percentf(counts/sum(counts))) %>%
  select(-counts) %>%
  pivot_wider(names_from=predicted_rating,values_from=perc)
```



### DO NOT USE, DO NOT REMOVE. FOR REFERENCE ONLY
```{r}
predict(model, newdata = testing, type = "prob") %>%
  mutate(predicted_rating=if_else(high>=low,"high","low")) %>%
  select(predicted_rating) %>%
  cbind(.,testing) %>%
  group_by(rating,predicted_rating) %>%
  summarise(counts=sum(n())) %>%
  mutate(perc=percentf(counts/sum(counts))) %>%
  select(-counts) %>%
  pivot_wider(names_from=predicted_rating,values_from=perc)
```

One-hot encode categorical features

```{r}
dummy <- dummyVars("~.",data=df_select)
df_onehot <- data.frame(predict(dummy,newdata=df_select))
head(df_onehot)
```

```{r}
df_model %>% write.csv("C:\\Users\\e672437\\Documents\\TBD\\model_data.csv")
```

```{r}
cor(,method = c("pearson"))
```


```{r}
{
  'is_claimed': [0,1],
  'restaurant_categoryamerican': [0,1],
  'restaurant_categoryasian': [0,1],
  'restaurant_categorybreakfast': [0,1],
  'restaurant_categorydesserts': [0,1],
  'restaurant_categoryeuropean': [0,1],
  'restaurant_categoryhawaiian': [0,1],
  'restaurant_categorylatin': [0,1],
  'restaurant_categorymideastern': [0,1],
  'restaurant_categoryother': [0,1],
  'pickup': [0,1],
  'delivery': [0,1],
  'reservation': [0,1],
  'priceVeryHigh': [0,1],
  'priceHigh': [0,1],
  'priceMedium': [0,1],
  'priceLow': [0,1],
  'messaging': [0,1],
  'Open_Breakfast': [0,1],
  'Open_Lunch': [0,1],
  'Open_Dinner': [0,1],
  'Open_Late': [0,1]
}
```
